<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculator</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #0a0a0f;
      background-image:
        radial-gradient(ellipse at 20% 50%, rgba(120, 40, 200, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 20%, rgba(0, 200, 255, 0.1) 0%, transparent 50%);
      font-family: 'Share Tech Mono', 'Courier New', monospace;
    }

    .calculator {
      width: 340px;
      background: linear-gradient(145deg, #1a1a2e, #16213e);
      border-radius: 24px;
      padding: 24px;
      box-shadow:
        0 0 0 1px rgba(100, 200, 255, 0.1),
        0 20px 60px rgba(0, 0, 0, 0.8),
        0 0 40px rgba(80, 0, 200, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      position: relative;
    }

    .calculator::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: 25px;
      background: linear-gradient(135deg, rgba(100, 200, 255, 0.3), transparent 40%, rgba(150, 50, 255, 0.3));
      z-index: -1;
    }

    /* Display area */
    .display {
      background: #060d1a;
      border-radius: 14px;
      padding: 16px 20px;
      margin-bottom: 20px;
      min-height: 110px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: flex-end;
      border: 1px solid rgba(0, 200, 255, 0.15);
      box-shadow:
        inset 0 2px 10px rgba(0, 0, 0, 0.5),
        0 0 20px rgba(0, 200, 255, 0.05);
      overflow: hidden;
    }

    .expression {
      font-size: 14px;
      color: rgba(100, 200, 255, 0.5);
      min-height: 20px;
      letter-spacing: 1px;
      word-break: break-all;
      text-align: right;
    }

    .result {
      font-size: 44px;
      color: #e0f4ff;
      text-shadow: 0 0 20px rgba(0, 200, 255, 0.6);
      letter-spacing: 2px;
      word-break: break-all;
      text-align: right;
      transition: color 0.2s;
    }

    .result.error {
      font-size: 22px;
      color: #ff6b6b;
      text-shadow: 0 0 20px rgba(255, 100, 100, 0.6);
    }

    /* Button grid */
    .buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    button {
      height: 68px;
      border: none;
      border-radius: 14px;
      font-family: inherit;
      font-size: 20px;
      cursor: pointer;
      transition: transform 0.08s, box-shadow 0.08s, background 0.1s;
      position: relative;
      overflow: hidden;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    button::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0);
      transition: background 0.1s;
      border-radius: inherit;
    }

    button:active::after {
      background: rgba(255, 255, 255, 0.1);
    }

    button:active {
      transform: scale(0.94);
    }

    /* Number buttons */
    .btn-num {
      background: linear-gradient(145deg, #1e2d4a, #162236);
      color: #c8e6f5;
      box-shadow:
        4px 4px 8px rgba(0, 0, 0, 0.4),
        -1px -1px 4px rgba(80, 150, 200, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .btn-num:hover {
      background: linear-gradient(145deg, #243655, #1a2a40);
      box-shadow:
        4px 4px 10px rgba(0, 0, 0, 0.5),
        -1px -1px 4px rgba(80, 150, 200, 0.12),
        0 0 12px rgba(0, 150, 255, 0.08);
    }

    /* Operator buttons */
    .btn-op {
      background: linear-gradient(145deg, #1a1060, #100a45);
      color: #a78bfa;
      font-size: 22px;
      box-shadow:
        4px 4px 8px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(150, 100, 255, 0.15);
    }

    .btn-op:hover {
      background: linear-gradient(145deg, #221575, #140e58);
      color: #c4b5fd;
      box-shadow:
        4px 4px 10px rgba(0, 0, 0, 0.5),
        0 0 16px rgba(120, 80, 255, 0.25);
    }

    /* Equals button */
    .btn-eq {
      background: linear-gradient(145deg, #0080c0, #005a90);
      color: #ffffff;
      font-size: 26px;
      box-shadow:
        4px 4px 10px rgba(0, 0, 0, 0.5),
        0 0 20px rgba(0, 150, 255, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .btn-eq:hover {
      background: linear-gradient(145deg, #0090d8, #0068a8);
      box-shadow:
        4px 4px 12px rgba(0, 0, 0, 0.5),
        0 0 30px rgba(0, 180, 255, 0.4);
    }

    /* Clear/special buttons */
    .btn-clear {
      background: linear-gradient(145deg, #500015, #3a0010);
      color: #ff8096;
      box-shadow:
        4px 4px 8px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 100, 120, 0.1);
    }

    .btn-clear:hover {
      background: linear-gradient(145deg, #65001b, #4a0015);
      color: #ffaabb;
      box-shadow:
        4px 4px 10px rgba(0, 0, 0, 0.5),
        0 0 16px rgba(255, 80, 100, 0.25);
    }

    .btn-back {
      background: linear-gradient(145deg, #3a2000, #2a1800);
      color: #ffa040;
      box-shadow:
        4px 4px 8px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 150, 50, 0.1);
    }

    .btn-back:hover {
      background: linear-gradient(145deg, #4a2800, #361f00);
      color: #ffb860;
      box-shadow:
        4px 4px 10px rgba(0, 0, 0, 0.5),
        0 0 16px rgba(255, 150, 50, 0.2);
    }

    .btn-zero {
      grid-column: span 2;
    }

    /* Ripple animation on click */
    @keyframes ripple {
      0% { transform: scale(0); opacity: 0.5; }
      100% { transform: scale(3); opacity: 0; }
    }

    .ripple-effect {
      position: absolute;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.15);
      transform: scale(0);
      animation: ripple 0.4s linear;
      pointer-events: none;
    }

    /* Glitch animation on result update */
    @keyframes glitch {
      0%   { clip-path: inset(0 0 95% 0); transform: skewX(-5deg); }
      20%  { clip-path: inset(30% 0 60% 0); transform: skewX(3deg); }
      40%  { clip-path: inset(60% 0 20% 0); transform: skewX(-2deg); }
      60%  { clip-path: inset(80% 0 5% 0);  transform: skewX(4deg); }
      80%  { clip-path: inset(10% 0 80% 0); transform: skewX(-1deg); }
      100% { clip-path: inset(0 0 0 0);     transform: skewX(0); }
    }

    .result.flash {
      animation: flash 0.25s ease;
    }

    @keyframes flash {
      0%   { opacity: 1; }
      30%  { opacity: 0.4; color: #00ffff; text-shadow: 0 0 30px rgba(0, 255, 255, 0.9); }
      100% { opacity: 1; }
    }

    /* Scanline effect on display */
    .display::after {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 3px,
        rgba(0, 0, 0, 0.03) 3px,
        rgba(0, 0, 0, 0.03) 4px
      );
      pointer-events: none;
      border-radius: 14px;
    }

    .display {
      position: relative;
    }

    /* Title label */
    .calc-label {
      text-align: center;
      font-size: 10px;
      letter-spacing: 4px;
      color: rgba(100, 200, 255, 0.3);
      margin-bottom: 16px;
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="calculator">
    <div class="calc-label">◆ CALCULATOR ◆</div>
    <div class="display">
      <div class="expression" id="expression"></div>
      <div class="result" id="result">0</div>
    </div>
    <div class="buttons">
      <!-- Row 1 -->
      <button class="btn-clear" data-action="clear">AC</button>
      <button class="btn-back" data-action="backspace">⌫</button>
      <button class="btn-op" data-action="percent">%</button>
      <button class="btn-op" data-action="op" data-value="÷">÷</button>
      <!-- Row 2 -->
      <button class="btn-num" data-action="num" data-value="7">7</button>
      <button class="btn-num" data-action="num" data-value="8">8</button>
      <button class="btn-num" data-action="num" data-value="9">9</button>
      <button class="btn-op" data-action="op" data-value="×">×</button>
      <!-- Row 3 -->
      <button class="btn-num" data-action="num" data-value="4">4</button>
      <button class="btn-num" data-action="num" data-value="5">5</button>
      <button class="btn-num" data-action="num" data-value="6">6</button>
      <button class="btn-op" data-action="op" data-value="−">−</button>
      <!-- Row 4 -->
      <button class="btn-num" data-action="num" data-value="1">1</button>
      <button class="btn-num" data-action="num" data-value="2">2</button>
      <button class="btn-num" data-action="num" data-value="3">3</button>
      <button class="btn-op" data-action="op" data-value="+">+</button>
      <!-- Row 5 -->
      <button class="btn-num btn-zero" data-action="num" data-value="0">0</button>
      <button class="btn-num" data-action="decimal">.</button>
      <button class="btn-eq" data-action="equals">=</button>
    </div>
  </div>

  <script>
    const display = {
      expression: document.getElementById('expression'),
      result:     document.getElementById('result'),
    };

    const state = {
      current:    '0',   // current input string
      operand:    null,  // stored operand (number)
      operator:   null,  // stored operator symbol
      justCalc:   false, // true right after "=" pressed
    };

    function updateDisplay(animate = false) {
      display.result.textContent = state.current;
      display.result.classList.remove('error');
      if (animate) {
        display.result.classList.remove('flash');
        void display.result.offsetWidth; // reflow
        display.result.classList.add('flash');
      }
    }

    function formatNumber(n) {
      if (!isFinite(n)) return 'Error';
      // Avoid floating-point drift display
      const str = String(parseFloat(n.toPrecision(12)));
      return str;
    }

    function calculate(a, op, b) {
      switch (op) {
        case '+': return a + b;
        case '−': return a - b;
        case '×': return a * b;
        case '÷': return b === 0 ? null : a / b;
        default:  return b;
      }
    }

    function handleNum(val) {
      if (state.justCalc) {
        state.current = val;
        state.justCalc = false;
      } else if (state.current === '0') {
        state.current = val;
      } else if (state.current.length < 14) {
        state.current += val;
      }
      updateDisplay();
    }

    function handleDecimal() {
      if (state.justCalc) {
        state.current = '0.';
        state.justCalc = false;
      } else if (!state.current.includes('.')) {
        state.current += '.';
      }
      updateDisplay();
    }

    function handleOperator(op) {
      state.justCalc = false;
      const cur = parseFloat(state.current);

      if (state.operand !== null && state.operator !== null) {
        const res = calculate(state.operand, state.operator, cur);
        if (res === null) {
          showError('ゼロ除算');
          return;
        }
        state.operand = res;
        state.current = formatNumber(res);
      } else {
        state.operand = cur;
      }

      state.operator = op;
      display.expression.textContent = `${formatNumber(state.operand)} ${op}`;
      updateDisplay();
    }

    function handleEquals() {
      if (state.operator === null || state.operand === null) return;
      const cur = parseFloat(state.current);
      const res = calculate(state.operand, state.operator, cur);
      if (res === null) {
        showError('ゼロ除算');
        return;
      }
      display.expression.textContent =
        `${formatNumber(state.operand)} ${state.operator} ${formatNumber(cur)} =`;
      state.current = formatNumber(res);
      state.operand = null;
      state.operator = null;
      state.justCalc = true;
      updateDisplay(true);
    }

    function handleClear() {
      state.current   = '0';
      state.operand   = null;
      state.operator  = null;
      state.justCalc  = false;
      display.expression.textContent = '';
      updateDisplay();
    }

    function handleBackspace() {
      if (state.justCalc) { handleClear(); return; }
      if (state.current.length > 1) {
        state.current = state.current.slice(0, -1);
      } else {
        state.current = '0';
      }
      updateDisplay();
    }

    function handlePercent() {
      const n = parseFloat(state.current) / 100;
      state.current = formatNumber(n);
      state.justCalc = false;
      updateDisplay(true);
    }

    function showError(msg) {
      state.current   = '0';
      state.operand   = null;
      state.operator  = null;
      state.justCalc  = false;
      display.expression.textContent = '';
      display.result.textContent = msg;
      display.result.classList.add('error');
    }

    // Ripple effect helper
    function addRipple(btn, e) {
      const rect = btn.getBoundingClientRect();
      const x = (e.clientX ?? rect.left + rect.width / 2) - rect.left - 20;
      const y = (e.clientY ?? rect.top  + rect.height / 2) - rect.top  - 20;
      const ripple = document.createElement('span');
      ripple.className = 'ripple-effect';
      ripple.style.left = `${x}px`;
      ripple.style.top  = `${y}px`;
      btn.appendChild(ripple);
      ripple.addEventListener('animationend', () => ripple.remove());
    }

    // Event delegation
    document.querySelector('.buttons').addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;

      addRipple(btn, e);

      const action = btn.dataset.action;
      const value  = btn.dataset.value;

      switch (action) {
        case 'num':      handleNum(value);      break;
        case 'decimal':  handleDecimal();        break;
        case 'op':       handleOperator(value);  break;
        case 'equals':   handleEquals();         break;
        case 'clear':    handleClear();          break;
        case 'backspace':handleBackspace();      break;
        case 'percent':  handlePercent();        break;
      }
    });

    // Keyboard support
    document.addEventListener('keydown', (e) => {
      if (e.key >= '0' && e.key <= '9') { handleNum(e.key); return; }
      switch (e.key) {
        case '+': handleOperator('+'); break;
        case '-': handleOperator('−'); break;
        case '*': handleOperator('×'); break;
        case '/': e.preventDefault(); handleOperator('÷'); break;
        case 'Enter': case '=': handleEquals(); break;
        case 'Backspace': handleBackspace(); break;
        case 'Escape':    handleClear();      break;
        case '.': case ',': handleDecimal(); break;
        case '%': handlePercent(); break;
      }
    });
  </script>
</body>
</html>
